#!/usr/bin/env python3

import logging
import configparser
import MySQLdb as mariadb
import argparse

from sense_hat import SenseHat
from time import sleep, strftime
from datetime import datetime

def get_temperature(sense, offset):
    return sense.get_temperature() - offset


def update_temperature(db, temperature):
    try:
        cursor = db.cursor()
        statement = """
        CALL update_temperature(%s, %s, %s, %s, %s)
        """
        values = (1, datetime.now(), temperature, datetime.now(), '9999-12-31 23:59:59')
        cursor.execute(statement, values)
        db.commit()
    except Exception as err:
        logging.error(f'Could not update temperature in database: {err}')
        return False
    
    logging.info(f'Updated temperature to {temperature}')

def connect_to_database(config):
    db = False
    while not db:
        try:
            db = mariadb.connect(
                host=config['host'],
                port=int(config['port']),
                user=config['user'],
                password=config['password'],
                database=config['db']
            )
            return db
        except Exception as err:
            logging.error(f'Could not connect to database: {err}')
            db = False
        
        sleep(int(config['reconnect-interval']))

def main():
    parser = argparse.ArgumentParser()
    parser.parse_args()
    
    config = configparser.ConfigParser()
    config.read('./nerdytemp.ini')

    logging.basicConfig(level=logging.INFO)

    sense = SenseHat()
    db = connect_to_database(config['db'])
    while True:
        if not update_temperature(db, get_temperature(sense, int(config['nerdytemp']['offset']))):
            db = connect_to_database(config['db'])

        sleep(int(config['nerdytemp']['interval']))

    db.close()

if __name__ == '__main__':
    main()
